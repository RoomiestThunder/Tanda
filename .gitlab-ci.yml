# GitLab CI/CD Pipeline for Tanda Project
# Stages: lint/test → build → security → deploy (dev/stage/prod)
#
# Required GitLab CI/CD Variables (Settings → CI/CD → Variables):
# ============================================================================
# Docker Registry:
#   - CI_REGISTRY_USER: Your GitLab Registry username
#   - CI_REGISTRY_PASSWORD: Your GitLab Registry personal access token
#
# Yandex Cloud (Terraform):
#   - YC_TOKEN: Yandex Cloud OAuth token
#   - TF_STATE_BUCKET: S3 bucket name for terraform state
#   - TF_STATE_ENDPOINT: S3 endpoint (e.g., storage.yandexcloud.net)
#   - TF_STATE_REGION: S3 region (usually ru-central1)
#
# VM SSH Access (Base64 encoded private keys):
#   - SSH_PRIVATE_KEY_DEV: Base64 encoded SSH private key for dev VM
#     (Create with: cat ~/.ssh/id_rsa | base64)
#   - SSH_PRIVATE_KEY_STAGE: Base64 encoded SSH private key for stage VM
#   - SSH_PRIVATE_KEY_PROD: Base64 encoded SSH private key for prod VM
#
# VM IP Addresses:
#   - VM_IP_DEV: IP address of dev VM (from terraform output)
#   - VM_IP_STAGE: IP address of stage VM (from terraform output)
#   - VM_IP_PROD: IP address of prod VM (from terraform output)
#
# Optional (for notifications):
#   - SLACK_WEBHOOK: Slack webhook URL for deployment notifications
#   - TELEGRAM_BOT_TOKEN: Telegram bot token for alerts
# ============================================================================

stages:
  - lint
  - test
  - build
  - security
  - deploy_dev
  - deploy_stage
  - deploy_prod

variables:
  REGISTRY: "registry.gitlab.com"
  IMAGE_NAME: "$REGISTRY/$CI_PROJECT_PATH"
  # Docker image for terraform/helm operations
  TERRAFORM_IMAGE: "hashicorp/terraform:latest"

# ============================================================================
# LINT & TEST
# ============================================================================

lint:docker:
  stage: lint
  image: docker:latest
  services:
    - docker:dind
  script:
    - echo "Running Dockerfile linting..."
    - # Install hadolint or skip if not present
    - docker run --rm -i hadolint/hadolint < Dockerfile || echo "No Dockerfile found or hadolint not available"
  allow_failure: true
  only:
    - merge_requests
    - main
    - develop

lint:terraform:
  stage: lint
  image: $TERRAFORM_IMAGE
  script:
    - echo "Validating Terraform configuration..."
    - cd terraform && terraform init -backend=false
    - terraform validate
    - terraform fmt -check -recursive .
  allow_failure: true
  only:
    - merge_requests
    - main
    - develop

test:unit:
  stage: test
  image: ${CI_REGISTRY_IMAGE}:latest
  script:
    - echo "Running unit tests..."
    - # Replace with your app's test command (e.g., npm test, pytest, etc.)
    - echo "Tests passed (placeholder)"
  allow_failure: false
  only:
    - merge_requests
    - main
    - develop

# ============================================================================
# BUILD
# ============================================================================

build:docker:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  script:
    - echo "Building Docker image: $IMAGE_NAME:$CI_COMMIT_SHORT_SHA"
    - docker build -t $IMAGE_NAME:$CI_COMMIT_SHORT_SHA -t $IMAGE_NAME:latest .
    - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $REGISTRY
    - docker push $IMAGE_NAME:$CI_COMMIT_SHORT_SHA
    - docker push $IMAGE_NAME:latest
  only:
    - main
    - develop
    - tags

# ============================================================================
# SECURITY
# ============================================================================

security:container_scan:
  stage: security
  image: docker:latest
  services:
    - docker:dind
  script:
    - echo "Scanning Docker image for vulnerabilities..."
    - # Use trivy or snyk for container scanning
    - echo "Container scan completed (placeholder)"
  allow_failure: true
  only:
    - merge_requests
    - main
    - develop

security:dependencies:
  stage: security
  image: python:3.10
  script:
    - echo "Checking dependencies for known vulnerabilities..."
    - pip install safety || true
    - safety check || echo "No Python dependencies or safety not available"
  allow_failure: true
  only:
    - merge_requests
    - main
    - develop

security:secrets:
  stage: security
  image: python:3.10
  script:
    - echo "Scanning for hardcoded secrets..."
    - pip install detect-secrets || true
    - detect-secrets scan --all-files || echo "detect-secrets not available"
  allow_failure: true
  only:
    - merge_requests
    - main
    - develop

# ============================================================================
# DEPLOY TO DEV
# ============================================================================

deploy:dev:terraform:
  stage: deploy_dev
  image: $TERRAFORM_IMAGE
  environment:
    name: dev
    url: https://dev.tanda.example.com
  before_script:
    - cd terraform
    - terraform init -backend-config="bucket=$TF_STATE_BUCKET" -backend-config="key=tanda/dev/terraform.tfstate" -backend-config="endpoint=$TF_STATE_ENDPOINT"
  script:
    - echo "Deploying Terraform to dev environment..."
    - terraform workspace select dev || terraform workspace new dev
    - terraform plan -var-file=envs/dev.tfvars -out=tfplan.dev
    - terraform apply tfplan.dev
  artifacts:
    reports:
      terraform: [tfplan.dev]
  only:
    - develop
  when: on_success

deploy:dev:application:
  stage: deploy_dev
  image: alpine:latest
  environment:
    name: dev
    url: https://dev.tanda.example.com
  before_script:
    - apk add --no-cache openssh-client
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEY_DEV" | base64 -d > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan -H $VM_IP_DEV >> ~/.ssh/known_hosts 2>/dev/null
  script:
    - echo "Deploying application to dev VM via SSH..."
    - echo "Using image: $IMAGE_NAME:$CI_COMMIT_SHORT_SHA"
    - |
      ssh -i ~/.ssh/id_rsa ubuntu@$VM_IP_DEV << 'EOF'
      set -e
      echo "Pulling latest Docker image..."
      docker pull $IMAGE_NAME:$CI_COMMIT_SHORT_SHA
      
      echo "Stopping old container..."
      docker stop tanda-app || true
      docker rm tanda-app || true
      
      echo "Starting new container..."
      docker run -d \
        --name tanda-app \
        --restart always \
        -p 80:8080 \
        -p 443:8443 \
        -e ENVIRONMENT=dev \
        --env-file /etc/tanda/.env.dev \
        $IMAGE_NAME:$CI_COMMIT_SHORT_SHA
      
      echo "Waiting for container to be healthy..."
      sleep 5
      docker ps | grep tanda-app && echo "Container deployed successfully" || exit 1
      EOF
  only:
    - develop
  when: on_success
  dependencies:
    - build:docker

# ============================================================================
# DEPLOY TO STAGING
# ============================================================================

deploy:stage:terraform:
  stage: deploy_stage
  image: $TERRAFORM_IMAGE
  environment:
    name: stage
    url: https://stage.tanda.example.com
  before_script:
    - cd terraform
    - terraform init -backend-config="bucket=$TF_STATE_BUCKET" -backend-config="key=tanda/stage/terraform.tfstate" -backend-config="endpoint=$TF_STATE_ENDPOINT"
  script:
    - echo "Deploying Terraform to staging environment..."
    - terraform workspace select stage || terraform workspace new stage
    - terraform plan -var-file=envs/stage.tfvars -out=tfplan.stage
    - terraform apply tfplan.stage
  artifacts:
    reports:
      terraform: [tfplan.stage]
  only:
    - main
  when: on_success

deploy:stage:application:
  stage: deploy_stage
  image: alpine:latest
  environment:
    name: stage
    url: https://stage.tanda.example.com
  before_script:
    - apk add --no-cache openssh-client
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEY_STAGE" | base64 -d > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan -H $VM_IP_STAGE >> ~/.ssh/known_hosts 2>/dev/null
  script:
    - echo "Deploying application to stage VM via SSH..."
    - echo "Using image: $IMAGE_NAME:$CI_COMMIT_SHORT_SHA"
    - |
      ssh -i ~/.ssh/id_rsa ubuntu@$VM_IP_STAGE << 'EOF'
      set -e
      echo "Pulling latest Docker image..."
      docker pull $IMAGE_NAME:$CI_COMMIT_SHORT_SHA
      
      echo "Stopping old container..."
      docker stop tanda-app || true
      docker rm tanda-app || true
      
      echo "Starting new container..."
      docker run -d \
        --name tanda-app \
        --restart always \
        -p 80:8080 \
        -p 443:8443 \
        -e ENVIRONMENT=stage \
        --env-file /etc/tanda/.env.stage \
        $IMAGE_NAME:$CI_COMMIT_SHORT_SHA
      
      echo "Waiting for container to be healthy..."
      sleep 5
      docker ps | grep tanda-app && echo "Container deployed successfully" || exit 1
      EOF
  only:
    - main
  when: on_success
  dependencies:
    - build:docker

# ============================================================================
# DEPLOY TO PRODUCTION (MANUAL)
# ============================================================================

deploy:prod:terraform:
  stage: deploy_prod
  image: $TERRAFORM_IMAGE
  environment:
    name: prod
    url: https://tanda.example.com
  before_script:
    - cd terraform
    - terraform init -backend-config="bucket=$TF_STATE_BUCKET" -backend-config="key=tanda/prod/terraform.tfstate" -backend-config="endpoint=$TF_STATE_ENDPOINT"
  script:
    - echo "Deploying Terraform to production environment..."
    - terraform workspace select prod || terraform workspace new prod
    - terraform plan -var-file=envs/prod.tfvars -out=tfplan.prod
    - terraform apply tfplan.prod
  artifacts:
    reports:
      terraform: [tfplan.prod]
  only:
    - tags
  when: manual

deploy:prod:application:
  stage: deploy_prod
  image: alpine:latest
  environment:
    name: prod
    url: https://tanda.example.com
  before_script:
    - apk add --no-cache openssh-client
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEY_PROD" | base64 -d > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan -H $VM_IP_PROD >> ~/.ssh/known_hosts 2>/dev/null
  script:
    - echo "Deploying application to production VM via SSH (blue-green strategy)..."
    - echo "Using image: $IMAGE_NAME:$CI_COMMIT_SHORT_SHA"
    - |
      ssh -i ~/.ssh/id_rsa ubuntu@$VM_IP_PROD << 'EOF'
      set -e
      
      # Blue-green deployment strategy
      CURRENT=$(docker ps --filter "name=tanda-app-blue" -q | wc -l)
      
      if [ $CURRENT -gt 0 ]; then
        echo "Current container: blue, deploying to green..."
        DEPLOY_COLOR="green"
        REMOVE_COLOR="blue"
      else
        echo "Current container: green, deploying to blue..."
        DEPLOY_COLOR="blue"
        REMOVE_COLOR="green"
      fi
      
      echo "Pulling Docker image..."
      docker pull $IMAGE_NAME:$CI_COMMIT_SHORT_SHA
      
      echo "Starting new $DEPLOY_COLOR container..."
      docker run -d \
        --name tanda-app-$DEPLOY_COLOR \
        --restart always \
        -p 80:8080 \
        -p 443:8443 \
        -e ENVIRONMENT=prod \
        --env-file /etc/tanda/.env.prod \
        $IMAGE_NAME:$CI_COMMIT_SHORT_SHA
      
      echo "Health check for $DEPLOY_COLOR container..."
      sleep 10
      HEALTH=$(docker exec tanda-app-$DEPLOY_COLOR curl -s http://localhost:8080/health || echo "failed")
      
      if [ "$HEALTH" = "ok" ] || [ "$HEALTH" != "failed" ]; then
        echo "$DEPLOY_COLOR container is healthy, switching traffic..."
        
        # Update nginx or HAProxy to route to new color
        docker exec tanda-proxy nginx -s reload || echo "Proxy not found, manual DNS update needed"
        
        echo "Removing old $REMOVE_COLOR container..."
        sleep 5
        docker stop tanda-app-$REMOVE_COLOR || true
        docker rm tanda-app-$REMOVE_COLOR || true
        
        echo "Deployment completed successfully!"
      else
        echo "Health check failed! Rolling back..."
        docker stop tanda-app-$DEPLOY_COLOR
        docker rm tanda-app-$DEPLOY_COLOR
        exit 1
      fi
      EOF
  only:
    - tags
  when: manual
  dependencies:
    - build:docker

# ============================================================================
# ROLLBACK (Manual)
# ============================================================================

rollback:prod:
  stage: deploy_prod
  image: alpine:latest
  environment:
    name: prod
  before_script:
    - apk add --no-cache openssh-client
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEY_PROD" | base64 -d > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan -H $VM_IP_PROD >> ~/.ssh/known_hosts 2>/dev/null
  script:
    - echo "Rolling back production deployment..."
    - |
      ssh -i ~/.ssh/id_rsa ubuntu@$VM_IP_PROD << 'EOF'
      set -e
      
      echo "Checking current deployment..."
      CURRENT=$(docker ps --filter "name=tanda-app-blue" -q | wc -l)
      
      if [ $CURRENT -gt 0 ]; then
        echo "Current: blue, rolling back to green..."
        ROLLBACK_COLOR="green"
        REMOVE_COLOR="blue"
      else
        echo "Current: green, rolling back to blue..."
        ROLLBACK_COLOR="blue"
        REMOVE_COLOR="green"
      fi
      
      echo "Switching traffic back to $ROLLBACK_COLOR..."
      docker exec tanda-proxy nginx -s reload || echo "Manual rollback needed"
      
      echo "Removing failed $REMOVE_COLOR container..."
      docker stop tanda-app-$REMOVE_COLOR || true
      docker rm tanda-app-$REMOVE_COLOR || true
      
      echo "Rollback completed!"
      EOF
  when: manual
  only:
    - main
    - tags
